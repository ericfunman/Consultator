name: SonarCloud Analysis

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      run: |
        git clone https://github.com/${{ github.repository }}.git .
        git checkout ${{ github.sha }}

    - name: Set up Python
      run: |
        python3 --version
        pip3 install --upgrade pip

    - name: Install dependencies
      run: |
        pip3 install -r requirements.txt
        pip3 install -r requirements-test.txt

    - name: Create reports directory
      run: mkdir -p reports

    - name: Initialize database
      run: |
        python3 -c "from app.database.database import init_database; init_database()" || echo "Database init failed but continuing..."

    - name: Run tests with coverage
      run: |
        echo "🚀 Running tests with coverage..."
        python3 -m pytest tests/unit/test_basic_coverage.py tests/unit/test_force_coverage.py --cov=app --cov-report=xml:reports/coverage.xml --cov-report=term-missing -v --tb=short

    - name: Verify coverage file
      run: |
        echo "=== COVERAGE FILE VERIFICATION ==="
        if [ -f reports/coverage.xml ]; then
          echo "✅ Coverage file exists"
          echo "File size: $(wc -c < reports/coverage.xml) bytes"
          echo "Coverage percentage:"
          grep -o 'line-rate="[^"]*"' reports/coverage.xml || echo "No line-rate found"
          head -5 reports/coverage.xml
        else
          echo "❌ Coverage file missing!"
          ls -la reports/
          exit 1
        fi

    - name: Install SonarQube scanner
      run: |
        echo "🔧 Installing SonarQube scanner compatible with Java 11..."
        wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.6.2.2472-linux.zip
        unzip -q sonar-scanner-cli-4.6.2.2472-linux.zip
        export PATH=$PATH:$(pwd)/sonar-scanner-4.6.2.2472-linux/bin
        echo "✅ SonarQube scanner 4.6.2 installed (compatible with Java 11)"

    - name: SonarCloud Scan
      run: |
        echo "=== STARTING SONARQUBE ANALYSIS ==="
        export PATH=$PATH:$(pwd)/sonar-scanner-4.6.2.2472-linux/bin

        if [ -z "$SONAR_TOKEN" ]; then
          echo "❌ SONAR_TOKEN not found - skipping SonarQube analysis"
          echo "Please configure SONAR_TOKEN secret in GitHub repository settings"
          exit 1
        fi

        echo "✅ SONAR_TOKEN found"
        echo "🔍 Running SonarQube scanner..."

        sonar-scanner \
          -Dsonar.projectKey=ericfunman_Consultator \
          -Dsonar.organization=ericfunman \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.login=$SONAR_TOKEN \
          -Dsonar.python.coverage.reportPaths=reports/coverage.xml \
          -Dsonar.sources=app \
          -Dsonar.tests=tests \
          -Dsonar.exclusions=**/test_*.py,**/*_test.py,**/conftest.py,**/__pycache__/**
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
