#!/bin/sh
#
# Hook pre-commit pour Consultator
# ExÃ©cute automatiquement les tests de rÃ©gression avant chaque commit
#

echo "ğŸ” VÃ©rification pre-commit - Consultator"
echo "========================================"

# Couleurs pour l'affichage
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Fonction d'affichage colorÃ©
print_status() {
    if [ "$2" = "success" ]; then
        echo "${GREEN}âœ… $1${NC}"
    elif [ "$2" = "warning" ]; then
        echo "${YELLOW}âš ï¸ $1${NC}"
    else
        echo "${RED}âŒ $1${NC}"
    fi
}

# 1. VÃ©rifier que Python est disponible
if ! command -v python &> /dev/null; then
    print_status "Python n'est pas disponible" "error"
    echo "   Installez Python pour continuer"
    exit 1
fi

# 2. VÃ©rifier la structure des tests
if [ ! -d "tests/regression" ]; then
    print_status "Dossier tests/regression manquant" "error"
    echo "   ExÃ©cutez: python scripts/clean_test_environment.py"
    exit 1
fi

# 3. ExÃ©cuter les tests de rÃ©gression critiques
echo ""
echo "ğŸ›¡ï¸ Tests de rÃ©gression..."
python -m pytest tests/regression/test_vsa_import_regression.py -q

if [ $? -ne 0 ]; then
    print_status "Ã‰CHEC des tests de rÃ©gression !" "error"
    echo ""
    echo "ğŸš« COMMIT BLOQUÃ‰"
    echo "   Les tests de rÃ©gression doivent passer avant le commit"
    echo "   Corrigez les problÃ¨mes et recommencez"
    exit 1
fi

print_status "Tests de rÃ©gression OK" "success"

# 4. VÃ©rifier s'il y a de nouveaux fichiers Python sans tests
echo ""
echo "ğŸ” VÃ©rification des nouveaux fichiers..."

# RÃ©cupÃ©rer les fichiers Python modifiÃ©s/ajoutÃ©s
new_py_files=$(git diff --cached --name-only --diff-filter=A | grep '\.py$' | grep -v test_ | grep -v __pycache__)

if [ ! -z "$new_py_files" ]; then
    print_status "Nouveaux fichiers Python dÃ©tectÃ©s:" "warning"
    for file in $new_py_files; do
        echo "   ğŸ“„ $file"
    done
    
    echo ""
    echo "ğŸ’¡ Recommandation:"
    echo "   AprÃ¨s ce commit, exÃ©cutez:"
    echo "   python scripts/develop_tests_systematically.py 1"
    echo "   pour gÃ©nÃ©rer les tests associÃ©s"
fi

# 5. VÃ©rifier la couverture si des tests ont Ã©tÃ© modifiÃ©s
modified_tests=$(git diff --cached --name-only | grep test_ | grep '\.py$')

if [ ! -z "$modified_tests" ]; then
    echo ""
    echo "ğŸ§ª Tests modifiÃ©s dÃ©tectÃ©s..."
    print_status "ExÃ©cution des tests modifiÃ©s" "success"
    
    # ExÃ©cuter uniquement les tests modifiÃ©s
    python -m pytest $modified_tests -q
    
    if [ $? -ne 0 ]; then
        print_status "Ã‰CHEC des tests modifiÃ©s !" "error"
        echo ""
        echo "ğŸš« COMMIT BLOQUÃ‰"
        echo "   Les tests modifiÃ©s doivent passer avant le commit"
        exit 1
    fi
fi

# 6. Message de fin
echo ""
print_status "Pre-commit validÃ© !" "success"
echo "ğŸš€ Le commit peut continuer..."
echo ""

exit 0